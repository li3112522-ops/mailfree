<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>登录 - iMail</title>
    <style>.precheck-hide body{ visibility: hidden; }</style>
    <script>
      // 立即检查登录状态（在任何其他脚本之前）
      (function(){
        try{
          var hasToken = document.cookie.split(';').some(function(c){
            return c.trim().indexOf('iding-session=') === 0;
          });

          // 如果有cookie但是从其他页面跳转过来的，先验证有效性再跳转
          // 避免无效cookie导致的循环跳转和页面闪现
          if (hasToken && document.referrer) {
            // 异步验证，不阻止页面渲染
            (async function(){
              try{
                const controller = new AbortController();
                const tid = setTimeout(function(){ try{ controller.abort(); }catch(_){ } }, 1500);
                const r = await fetch('/api/session', {
                  method: 'GET',
                  headers: { 'Cache-Control': 'no-cache' },
                  credentials: 'include',
                  signal: controller.signal
                });
                clearTimeout(tid);
                if (r && r.ok){
                  location.replace('/');
                } else {
                  // cookie无效，清除它
                  document.cookie = 'iding-session=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                }
              }catch(_){
                // 验证失败，保持在登录页面
              }
            })();
            return;
          } else if (hasToken && !document.referrer) {
            // 直接访问登录页且有cookie，立即重定向
            location.replace('/');
            return;
          }

          // 没有cookie，做一次网络检查（可能cookie刚设置还没生效）
          fetch('/api/session', {
            method: 'GET',
            headers: { 'Cache-Control': 'no-cache' },
            credentials: 'include'
          }).then(function(r){
            if (r && r.ok){
              location.replace('/');
            }
          }).catch(function(){
            // 会话检查失败，保持在登录页面
          });
        }catch(_){
          // 错误处理，保持在登录页面
        }
      })();
    </script>
    <script src="/js/auth-guard.js"></script>
    <script>
      // 已登录访问登录页时直接回首页；登出场景跳过检查
      (function(){
        try{ document.documentElement.classList.add('precheck-hide'); }catch(_){ }
        try{
          var u = new URL(location.href);
          var fromLogout = (u.searchParams.get('from') === 'logout') || (sessionStorage.getItem('mf:just_logged_out') === '1');
          if (fromLogout){
            sessionStorage.removeItem('mf:just_logged_out');
            document.documentElement.classList.remove('precheck-hide');
            return;
          }
        }catch(_){ }
        // Cookie检查已在页面顶部执行，这里跳过重复检查
        // 2) 网络兜底，延长超时时间减少误判
        try{
          var controller = new AbortController();
          var tid = setTimeout(function(){ try{ controller.abort(); }catch(_){ } }, 1500); // 从500ms延长到1500ms
          fetch('/api/session', {
            headers: { 'Cache-Control': 'no-cache' },
            signal: controller.signal,
            credentials: 'include'
          })
            .then(function(r){
              clearTimeout(tid);
              if (r && r.ok){ location.replace('/'); return; }
              document.documentElement.classList.remove('precheck-hide');
            })
            .catch(function(){ try{ document.documentElement.classList.remove('precheck-hide'); }catch(_){ } });
        }catch(_){ try{ document.documentElement.classList.remove('precheck-hide'); }catch(_){ } }
        // 最长 2s 兜底显示（从1s延长到2s）
        setTimeout(function(){ try{ document.documentElement.classList.remove('precheck-hide'); }catch(_){ } }, 2000);
      })();
    </script>

    <script src="/js/mock.js"></script>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <link rel="shortcut icon" href="/favicon.svg" type="image/svg+xml" />
    <!-- Design System -->
    <link rel="stylesheet" href="/css/variables.css" />
    <link rel="stylesheet" href="/css/base.css" />
    <link rel="stylesheet" href="/css/animations.css" />
    <link rel="stylesheet" href="/css/components/buttons.css" />
    <link rel="stylesheet" href="/css/components/inputs.css" />
    <link rel="stylesheet" href="/css/components/cards.css" />
    <link rel="stylesheet" href="/css/components/modals.css" />
    <link rel="stylesheet" href="/css/login.css" />
    <script src="/js/icons.js"></script>
  </head>
  <body>
    <div class="login-container">
      <div class="login-card card">
        <div class="login-header">
          <div class="login-logo">
            <svg class="icon icon-mail" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect width="20" height="16" x="2" y="4" rx="2"/>
              <path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/>
            </svg>
          </div>
          <h1 class="login-title">iMail</h1>
          <p class="login-subtitle">安全登录到您的临时邮箱</p>
        </div>

        <div id="err" class="login-error"></div>

        <form id="login-form" class="login-form">
          <div class="form-group">
            <label class="form-label" for="username">
              <svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
              </svg>
              用户名
            </label>
            <input id="username" class="input" type="text" placeholder="请输入用户名或邮箱" autocomplete="username" />
          </div>

          <div class="form-group">
            <label class="form-label" for="pwd">
              <svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect width="18" height="11" x="3" y="11" rx="2" ry="2"/>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
              </svg>
              密码
            </label>
            <input id="pwd" class="input" type="password" placeholder="请输入密码" autocomplete="current-password" />
          </div>

          <div class="login-hint">
            <svg class="icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"/>
              <path d="M12 16v-4"/>
              <path d="M12 8h.01"/>
            </svg>
            <span>账号：<strong>guest</strong>，密码：<strong>admin</strong>，将进入观看模式。</span>
          </div>

          <button id="login" type="submit" class="btn btn-primary btn-lg btn-block">
            <svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/>
              <polyline points="10 17 15 12 10 7"/>
              <line x1="15" x2="3" y1="12" y2="12"/>
            </svg>
            <span>登录</span>
          </button>
        </form>
      </div>
    </div>
    <div id="toast" class="toast"></div>
    <script src="/js/toast-utils.js"></script>
    <script src="/js/login.js"></script>
  </body>
</html>
